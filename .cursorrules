# SG-Imports: AI Instructions & Project Context

You are an expert Senior Full Stack Developer. You strictly follow the project's tech stack: Next.js 16 (App Router), React 19, Hero UI, Drizzle ORM, Tailwind CSS 4, Inngest, and next-intl.

## üéØ Project Vision

- **Niche:** Import/Logistics Management System for Brazil.
- **Core Goal:** Automate Siscomex/DUIMP processes, tax calculation (II, IPI, PIS, COFINS), and shipment tracking.
- **Architecture:** Multi-tenant SaaS (Organizations & Memberships).

## üõ† Tech Stack Rules

- **Runtime:** Bun (Always use `bun` commands).
- **Frontend:** Next.js 16 (App Router) + React 19 (Server Components by default).
- **UI:** Hero UI 3.0.0 (@heroui/react) for ALL components, but use the components of `src/components/ui/*.tsx`.
- **Hero UI Table Limitation:** Hero UI v3 beta 6 lacks a native Table component. Use the custom wrapper `src/components/ui/data-table.tsx`. If a table is needed, implement it with native HTML tags + Tailwind classes or @tanstack/react-table.
- **Database:** PostgreSQL (Supabase) + Drizzle ORM (`postgres.js` driver).
- **Workflows:** Inngest for durable execution and complex sagas.

## üìù Coding Standards & Architecture

1. **Directory Structure:**
   - Database Schema: `src/db/schema.ts`.
   - Business Logic: `src/services/*.ts` (Data Access Layer).
   - Server Actions: `src/app/actions/*.ts` or locally in `(dashboard)/.../actions.ts`.
2. **Naming:** English for code/DB. Tax terms: English + Brazilian acronym comment (e.g. `importTax` // II).
3. **i18n (next-intl):**
   - NO hardcoded strings. Use `useTranslations` or `getTranslations`.
   - Update ONLY `messages/pt.json` dictionary. Use keys like `"Shipments.List.title"`.
4. **Data Consistency:**
   - JSONB columns for simulations MUST use `ProductSnapshot` type.
   - Strictly type Drizzle JSON columns using `.$type<T>()`.
5. **Form Handling:**
   - Always use `zod` for schema validation.
   - Use Server Actions + React 19 `useActionState` for form feedback.
   - Utilize lucide-react icons

## üì° Data Fetching & State

- **Server-First:** Fetch data in Server Components via Services. Use `Suspense`.
- **Mutations:** Use Server Actions + `revalidatePath/revalidateTag`.
- **SWR:** Use ONLY for client-side polling or real-time status (ShipsGo, Asaas).
- **Context API:** Use for persistent shared state (OrganizationContext, ShipmentContext). Use the "Split Context" pattern (State/Dispatch) for performance.

## ‚ö° Inngest & Workflow Rules (CRITICAL)

- **Patterns:** Use `step.run` for all side effects and `step.waitForEvent` for long-running pauses (ZapSign signature, Payment).
- **Idempotency:** All steps must be idempotent. Use `ON CONFLICT DO NOTHING`.
- **Concurrency:** Limit by `shipmentId` or `organizationId` to prevent race conditions.

## üí° AI Efficiency & Monetary Rules

- **Context:** Always reference `@src/db/schema.ts` before writing queries.
- **Monetary Values:** NEVER use `float`. Use `decimal` (Drizzle) or `integer` (cents).
- **Currency:** Explicitly handle conversion between BRL, USD, and CNY. Store the `exchangeRate` used in every transaction.

## üáßüá∑ Brazil Import Logic

- **Taxes:** Cascade logic: Base II -> IPI -> PIS/COFINS -> ICMS.
- **NCM:** Primary key for tax logic.
- **Display:** Store ISO 8601, display `DD/MM/YYYY`.
